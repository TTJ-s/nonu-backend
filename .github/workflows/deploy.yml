name: Node.js CI/CD with PM2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 3. Deploy to server via SSH using password
      - name: Deploy to server
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            # Use GitHub repo name as folder
            APP_NAME="${GITHUB_REPOSITORY##*/}"
            APP_PATH="/home/linuxuser/apps/$APP_NAME"

            # Create folder if it doesn't exist
            mkdir -p "$APP_PATH"
            cd "$APP_PATH"

            # Pull latest code
            git fetch --all
            git reset --hard origin/main

            # Load env from server
            export $(grep -v '^#' /home/linuxuser/nonu/env/.env.development | xargs)

            # Install dependencies
            npm install

            # Restart app with PM2
            # pm2 stop "$APP_NAME" || true
            pm2 start ecosystem.config.js --name "$APP_NAME" --env development
            pm2 save
